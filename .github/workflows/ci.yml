name: CI Tests

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test:
    name: Test CheatSheets CLI
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up environment
      run: |
        echo "CS_ROOT=$GITHUB_WORKSPACE" >> $GITHUB_ENV
        chmod +x cs install.sh

    - name: Install dependencies
      run: |
        # Install fzf for interactive features
        git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
        ~/.fzf/install --all --no-update-rc --no-bash --no-zsh
        export PATH="$HOME/.fzf/bin:$PATH"

        # Install shellcheck for shell script validation
        sudo apt-get update
        sudo apt-get install -y shellcheck

    - name: Validate shell scripts
      run: |
        echo "Checking shell script syntax..."
        shellcheck cs || true
        shellcheck install.sh || true
        bash -n cs
        bash -n install.sh
        echo "✓ Shell scripts are valid"

    - name: Test installation script
      run: |
        echo "Testing installation script..."
        ./install.sh
        echo "✓ Installation completed"

    - name: Test cs help command
      run: |
        echo "Testing cs help..."
        ./cs help
        echo "✓ Help command works"

    - name: Test cs index command
      run: |
        echo "Testing cs index..."
        ./cs index
        echo "✓ Index built successfully"

        # Verify index was created
        if [ ! -f .cs_index ]; then
          echo "✗ Index file not created"
          exit 1
        fi
        echo "✓ Index file created"

    - name: Test cs quick command
      run: |
        echo "Testing cs quick..."
        ./cs quick "test command for CI"

        # Verify personal directory was created
        if [ ! -d personal ]; then
          echo "✗ Personal directory not created"
          exit 1
        fi

        # Verify quick.md was created
        if [ ! -f personal/quick.md ]; then
          echo "✗ quick.md not created"
          exit 1
        fi

        # Verify command was added
        if ! grep -q "test command for CI" personal/quick.md; then
          echo "✗ Command not added to quick.md"
          exit 1
        fi

        echo "✓ Quick add works"

    - name: Test cs add command
      run: |
        echo "Testing cs add with metadata..."
        ./cs add "docker ps -a" --desc "List all containers" --tags docker,containers --cat tools/docker

        # Verify command was added to docker.md
        if ! grep -q "docker ps -a" tools/docker.md; then
          echo "✗ Command not added to docker.md"
          exit 1
        fi

        echo "✓ Standard add works"

    - name: Test cs search command
      run: |
        echo "Testing cs search..."
        ./cs search docker > /dev/null 2>&1 || true
        echo "✓ Search command works"

    - name: Test cs list command
      run: |
        echo "Testing cs list..."
        ./cs list
        echo "✓ List command works"

    - name: Test cs stats command
      run: |
        echo "Testing cs stats..."
        ./cs stats
        echo "✓ Stats command works"

    - name: Test cs new command
      run: |
        echo "Testing cs new with tool template..."
        ./cs new test-tool --template tool < /dev/null || true

        # Verify file was created
        if [ ! -f tools/test-tool.md ]; then
          echo "✗ New section not created"
          exit 1
        fi

        echo "✓ New section creation works"

    - name: Test template files
      run: |
        echo "Validating templates..."

        # Check templates exist
        for template in tool k8s simple; do
          if [ ! -f "templates/${template}.md" ]; then
            echo "✗ Template ${template}.md not found"
            exit 1
          fi
        done

        echo "✓ All templates present"

    - name: Validate markdown files
      run: |
        echo "Checking markdown files..."

        # Count markdown files
        md_count=$(find . -name "*.md" -type f ! -path "*/.*" ! -path "*/personal/*" | wc -l)
        echo "Found $md_count markdown files"

        # Check for common issues
        find . -name "*.md" -type f ! -path "*/.*" ! -path "*/personal/*" | while read -r file; do
          # Check file is not empty
          if [ ! -s "$file" ]; then
            echo "✗ Empty file: $file"
            exit 1
          fi
        done

        echo "✓ Markdown files validated"

    - name: Test search index content
      run: |
        echo "Validating search index..."

        # Rebuild index
        ./cs index

        # Check index has content
        if [ ! -s .cs_index ]; then
          echo "✗ Index is empty"
          exit 1
        fi

        line_count=$(wc -l < .cs_index)
        echo "Index contains $line_count entries"

        if [ "$line_count" -lt 10 ]; then
          echo "✗ Index has too few entries"
          exit 1
        fi

        echo "✓ Search index validated"

    - name: Test configuration file
      run: |
        echo "Testing configuration..."

        # Check example config exists
        if [ ! -f .cs.config.example ]; then
          echo "✗ Example config not found"
          exit 1
        fi

        # Verify it's valid bash
        bash -n .cs.config.example

        echo "✓ Configuration file validated"

    - name: Summary
      run: |
        echo ""
        echo "======================================="
        echo "All tests passed!"
        echo "======================================="
        echo ""
        echo "Tested:"
        echo "  ✓ Installation script"
        echo "  ✓ Shell script syntax"
        echo "  ✓ cs help"
        echo "  ✓ cs index"
        echo "  ✓ cs quick"
        echo "  ✓ cs add"
        echo "  ✓ cs search"
        echo "  ✓ cs list"
        echo "  ✓ cs stats"
        echo "  ✓ cs new"
        echo "  ✓ Templates"
        echo "  ✓ Markdown files"
        echo "  ✓ Search index"
        echo "  ✓ Configuration"
        echo ""

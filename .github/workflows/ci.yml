name: CI Tests

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test:
    name: Test CheatSheets CLI
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up environment
      run: |
        echo "CS_ROOT=$GITHUB_WORKSPACE" >> $GITHUB_ENV
        chmod +x cs install.sh test.sh

    - name: Install shellcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck

    - name: Validate shell scripts
      run: |
        echo "Checking shell script syntax..."
        shellcheck cs || true
        shellcheck install.sh || true
        bash -n cs
        bash -n install.sh
        echo "✓ Shell scripts are valid"

    - name: Test installation script
      run: |
        echo "Testing installation script..."
        ./install.sh
        echo "✓ Installation completed"

    - name: Test cs help command
      run: |
        echo "Testing cs help..."
        ./cs help
        echo "✓ Help command works"

    - name: Test cs quick command
      run: |
        echo "Testing cs quick..."
        ./cs quick "test command for CI"

        # Verify personal directory was created
        if [ ! -d personal ]; then
          echo "✗ Personal directory not created"
          exit 1
        fi

        # Verify quick.md was created
        if [ ! -f personal/quick.md ]; then
          echo "✗ quick.md not created"
          exit 1
        fi

        # Verify command was added
        if ! grep -q "test command for CI" personal/quick.md; then
          echo "✗ Command not added to quick.md"
          exit 1
        fi

        echo "✓ Quick add works"

    - name: Test cs search command
      run: |
        echo "Testing cs search..."
        ./cs search docker > /dev/null 2>&1 || true
        echo "✓ Search command works"

    - name: Test cs list command
      run: |
        echo "Testing cs list..."
        ./cs list
        echo "✓ List command works"

    - name: Validate markdown files
      run: |
        echo "Checking markdown files..."

        # Count markdown files
        md_count=$(find . -name "*.md" -type f ! -path "*/.*" ! -path "*/personal/*" | wc -l)
        echo "Found $md_count markdown files"

        # Check for common issues
        find . -name "*.md" -type f ! -path "*/.*" ! -path "*/personal/*" | while read -r file; do
          # Check file is not empty
          if [ ! -s "$file" ]; then
            echo "✗ Empty file: $file"
            exit 1
          fi
        done

        echo "✓ Markdown files validated"

    - name: Run test suite
      run: |
        echo "Running full test suite..."
        ./test.sh

    - name: Summary
      run: |
        echo ""
        echo "======================================="
        echo "All tests passed!"
        echo "======================================="
        echo ""
        echo "Tested:"
        echo "  ✓ Installation script"
        echo "  ✓ Shell script syntax"
        echo "  ✓ cs help"
        echo "  ✓ cs quick"
        echo "  ✓ cs search"
        echo "  ✓ cs list"
        echo "  ✓ Markdown files"
        echo "  ✓ Full test suite (10 tests)"
        echo ""
